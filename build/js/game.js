define(["lodash","backbone","jquery","js/enum","js/views/header","js/models/dataAccessor"],function(e,t,n,r,i,o){var s={eventsBus:e.extend({},t.Events),db:null,router:null,status:r.GameStatus.LOADING,initializeDfd:new n.Deferred};return e.extend(s,{VERSION:"0.2",initialize:function(t){var a=new i({el:n("#header").get(0)});return this.router=t,this.printVersionInfo(),a.render(),this.checkBrowser()?(this.eventsBus.on("header.toggleInstructions",e.bind(a.toggleInstructions,a)),this.db=new o({encrypter:CryptoJS}),void this.initializeDB().done(function(){s.status=r.GameStatus.READY,s.initializeUser().then(function(e){s.db.saveCurrentUserName(e.get("name")),s.eventsBus.trigger("levels.loaded"),s.initializeDfd.resolve()})}).fail(function(){return t.navigate("error/"+r.GameErrorTypes.NO_LEVELS_LOADED,{trigger:!0})})):t.navigate("error/"+r.GameErrorTypes.OLD_BROWSER,{trigger:!0})},onInitialize:function(e){n.when(this.initializeDfd).done(e)},printVersionInfo:function(){var r=console&&console.log||function(){};r.call(console,"==========================="),r.call(console,"= Backbone: "+t.VERSION),r.call(console,"= Lodash: "+e.VERSION),r.call(console,"= jQuery: "+n.fn.jquery),r.call(console,"= Link It: "+this.VERSION),r.call(console,"===========================")},checkBrowser:function(){return!(!window.indexedDB||!window.localStorage)},initializeDB:function(){return this.db.initDB().then(function(){return s.db.getLevelsCount()<1?s.db.fetchLevels().then(function(){s.eventsBus.trigger("levels.loaded")}):void 0})},initializeUser:function(){return this.db.initUser(this.db.getCurrentUserName())},navigateToLevel:function(e){var t=this.router,n=this.db;return this.db.getCurrentUserActiveLevel().then(function(i){return i>=e?n.getLevelsCount()>=e?(t.navigate("level/"+e),t.hideCurrentView(),t.showLevelView(e)):t.navigate("gameOver",{trigger:!0}):t.navigate("error/"+r.GameErrorTypes.PAGE_NOT_FOUND,{trigger:!0})},function(){return t.navigate("error/"+r.GameErrorTypes.USER_ERROR,{trigger:!0})})},updateActiveLevel:function(e){var t=this.db;return t.getCurrentUserActiveLevel().then(function(n){return n===e?t.setCurrentUserActiveLevel(e+1):e+1})}}),s});