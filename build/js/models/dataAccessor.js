define(["lodash","backbone","jquery","js/models/LevelsPool","js/enum","js/models/UserModel"],function(e,t,r,n,o,s){return t.Model.extend({defaults:{DB_NAME:"LinkItDB",DB_VERSION:8,DB_LEVELS_STORAGE:"levels",DB_USERS_STORAGE:"users",DB_USER_ID_KEY:"userId",url:"./js/levels.json",levelsCount:null,db:null},initDB:function(){function t(e){e.onversionchange=function(){e.close()}}var n=new r.Deferred,o=window.indexedDB.open(this.get("DB_NAME"),this.get("DB_VERSION")),s=this;return o.onsuccess=function(){s.set("db",this.result),t(this.result),s.fetchLevelsCount().then(function(e){1>e?s.fetchLevels().always(n.resolve):n.resolve()},function(){n.reject()})},o.onerror=function(){n.reject()},o.onupgradeneeded=function(){var t,r,o=this.result;s.set("db",o),s.clearDB([s.get("DB_LEVELS_STORAGE")]),t=o.createObjectStore(s.get("DB_LEVELS_STORAGE"),{keyPath:"id",autoIncrement:!0}),e.contains(o.objectStoreNames,s.get("DB_USERS_STORAGE"))||(r=o.createObjectStore(s.get("DB_USERS_STORAGE"),{keyPath:"name",autoIncrement:!0})),t.createIndex("by_index","index",{unique:!0}),t.transaction.onerror=function(){n.reject()}},n},initUser:function(e){var t,n,o=this,a=new r.Deferred,c=this.get("db");return t=c.transaction(this.get("DB_USERS_STORAGE"),"readonly").objectStore(this.get("DB_USERS_STORAGE")),n=t.get(e||""),n.onerror=function(){a.reject()},n.onsuccess=function(e){var t,r=e.target.result;r?a.resolve(new s(r)):(t=c.transaction(o.get("DB_USERS_STORAGE"),"readwrite").objectStore(o.get("DB_USERS_STORAGE")),r=o.getDefaultUser(),t.add(r),t.transaction.oncomplete=function(){a.resolve(new s(r))},t.transaction.onerror=function(){a.reject()})},a},getCurrentUser:function(){var e,t=new r.Deferred,n=this.get("db");return e=n.transaction(this.get("DB_USERS_STORAGE"),"readonly").objectStore(this.get("DB_USERS_STORAGE")).get(this.getCurrentUserName()),e.onerror=function(){t.reject({code:o.GameErrorTypes.USER_ERROR})},e.onsuccess=function(e){var r=e.target.result;t.resolve(new s(r))},t},getDefaultUser:function(){return{name:"user"+e.random(Number.MAX_SAFE_INTEGER),activeLevel:1}},getCurrentUserName:function(){return window.localStorage.getItem(this.get("DB_USER_ID_KEY"))},saveCurrentUserName:function(t){t&&e.isString(t)&&window.localStorage.setItem(this.get("DB_USER_ID_KEY"),t)},getCurrentUserActiveLevel:function(){return this.getCurrentUser().then(function(e){return e.get("activeLevel")})},setCurrentUserActiveLevel:function(t){var n,s,a=new r.Deferred,c=this.get("db"),i=e.isNumber(t)?t:1;return n=c.transaction(this.get("DB_USERS_STORAGE"),"readwrite").objectStore(this.get("DB_USERS_STORAGE")),s=n.get(this.getCurrentUserName()),s.onerror=function(){a.reject({code:o.GameErrorTypes.USER_ERROR})},s.onsuccess=function(e){var t,r=e.target.result;r.activeLevel=i,t=n.put(r),t.onerror=function(){a.reject({code:o.GameErrorTypes.USER_ERROR})},t.transaction.oncomplete=function(){a.resolve(i)}},a},getLevel:function(t){var s,a,c=new r.Deferred,i=this.get("db");return e.isNumber(t)?(s=i.transaction(this.get("DB_LEVELS_STORAGE"),"readonly").objectStore(this.get("DB_LEVELS_STORAGE")),a=s.index("by_index").get(t),a.onsuccess=function(e){var t=e.target.result;t?c.resolve(n.get().init(t)):c.reject({code:o.GameErrorTypes.NO_LEVELS_LOADED})},a.onerror=function(){c.reject({code:o.GameErrorTypes.GENERIC})},c):c.reject()},fetchLevels:function(){var t=new r.Deferred,n=this;return r.getJSON(this.get("url")).then(function(s){function a(){i>u?r.when(n.loadImages(s.levels[u])).always(function(e){var r=c.transaction(n.get("DB_LEVELS_STORAGE"),"readwrite").objectStore(n.get("DB_LEVELS_STORAGE"));r.transaction.oncomplete=a,r.transaction.onerror=t.reject,r.add(e),u++}):(n.set("levelsCount",i),t.resolve())}if(!s||!e.isArray(s.levels))return t.reject({code:o.GameErrorTypes.NO_LEVELS_LOADED});var c=n.get("db"),i=s.levels.length,u=0;a()},function(){t.reject({code:o.GameErrorTypes.NO_LEVELS_LOADED})}),t},loadImages:function(t){var n=this,s=new r.Deferred,a=[];return e.forEach(t.basis,function(e){e.dataType===o.ItemDataType.IMAGE&&a.push(n.loadImage(e))}),e.forEach(t.targets,function(e){e.dataType===o.ItemDataType.IMAGE&&a.push(n.loadImage(e))}),r.when.apply(r,a).always(e.bind(s.resolve,s,t)),s},loadImage:function(e){var t=new r.Deferred,n=new XMLHttpRequest;return n.open("GET",e.data,!0),n.responseType="blob",n.addEventListener("load",function(){4===n.readyState&&(200===n.status&&(e.data=n.response),t.resolve())},!1),n.send(),t},getLevelsCount:function(){return this.get("levelsCount")||0},getAllLevels:function(){var e=this;return this.getCurrentUserActiveLevel().then(function(t){var s,a=new r.Deferred,c=e.get("db"),i=[];return s=c.transaction(e.get("DB_LEVELS_STORAGE"),"readonly").objectStore(e.get("DB_LEVELS_STORAGE")).openCursor(),s.onsuccess=function(e){var r,o=e.target.result;o?(r=o.value,r.available=r.index<=t,i.push(n.get().init(r)),o.continue()):a.resolve(i)},s.onerror=function(){a.reject({code:o.GameErrorTypes.NO_LEVELS_LOADED})},a})},fetchLevelsCount:function(){var e=new r.Deferred,t=this.get("db"),n=t.transaction(this.get("DB_LEVELS_STORAGE"),"readonly").objectStore(this.get("DB_LEVELS_STORAGE")),s=n.count(),a=this;return s.onsuccess=function(){a.set("levelsCount",this.result||0),e.resolve(this.result)},s.onerror=function(){a.set("levelsCount",null),e.reject({code:o.GameErrorTypes.NO_LEVELS_LOADED})},e},clearDB:function(t){var r=this.get("db");r&&e.forEach(t||r.objectStoreNames,function(t){e.contains(r.objectStoreNames,t)&&r.deleteObjectStore(t)})},deleteDB:function(){var e,t=new r.Deferred,n=this.get("db");return n&&n.close(),e=window.indexedDB.deleteDatabase(this.get("DB_NAME")),e.onsuccess=t.resolve,e.onerror=t.reject,t}})});